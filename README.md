# AI агент на LangGraph

Агент на Python строит динамическую цепочку обработки пользовательского запроса: определяет интенты через LLM, собирает маршрут `search -> summarize -> sentiment` либо уходит в `fallback`, обрабатывает шаги и возвращает итоговый ответ. Поддержан быстрый и глубокий режим поиска.

## Архитектура
- Состояние (`agent/models.py`): `user_query`, `detected_intents`, `intermediate_result`, `final_answer`, `next_intent_index`, `search_mode`.
- Граф (`agent/graph.py`): узлы `intent_recognition -> router -> {search|summarize|sentiment|fallback} -> ... -> finalize`. Маршрутизация по списку интентов; завершение в `finalize`.
- Ноды (`agent/handlers.py`): интенты, поиск, суммаризация, тональность, fallback; все ноды обновляют общее состояние и сдвигают `next_intent_index`.
- Цепочки (`agent/chains.py`): промпты + LLM с structured output для интентов и псевдо-поиска.
- CLI (`agent/cli.py`): цикл `input -> graph.invoke -> print`; новое состояние на каждый запрос с `search_mode="deep"`. Команды: `models` (показать список моделей), `model=<имя> [запрос]` (выбрать приоритетную модель и выполнить запрос).
- Отказоустойчивость LLM: на каждую ноду задан приоритезированный список моделей; при ошибке текущей берётся следующая (`agent/config.py`, `iter_llms_for_node`).

## LLM и конфигурация
- Поддерживаются Cloud.ru (GigaChat) и Groq; OpenRouter совместим, но бесплатные модели убраны из дефолта из-за жёстких лимитов (можно вернуть платные ключи вручную).
- Конфигурация моделей и сэмплинга — в `llm_config.yaml`: списки моделей и параметров на ноды (`intent`, `search`, `summarize`, `sentiment`, `fallback`); перебор до успешной.
- Параметры на модель: `temperature`, `top_p`, `max_tokens`, а также `base_url` и `api_key_env` для выбора провайдера.
- Дефолтный набор: `ai-sage/GigaChat3-10B-A1.8B` (Cloud.ru), `llama-3.1-8b-instant` (Groq). При необходимости добавьте OpenRouter модели и ключ в конфиг.
- Путь к кастомному конфигу можно задать через `LLM_CONFIG_PATH`.

### Почему такие модели
- `ai-sage/GigaChat3-10B-A1.8B` — первый приоритет: сильный русский, structured output/FC, размер в целевом диапазоне.
- `llama-3.1-8b-instant` — быстрый дешёвый фолбэк (Groq).
- OpenRouter free-модели исключены из дефолта: лимиты быстро сжигались; при наличии платного ключа их можно вернуть в конфиг.
- При недоступности/ошибке текущей модели система автоматически переключается на следующую.

## Переменные окружения
- `GROQ_API_KEY`, `GROQ_BASE_URL` — ключ и базовый URL Groq.  
- `OPENROUTER_API_KEY`, `OPENROUTER_BASE_URL` — ключ и базовый URL OpenRouter (если используете).  
- `CLOUDRU_API_KEY`, `CLOUDRU_BASE_URL` — ключ и базовый URL Cloud.ru (GigaChat).  
- `LLM_CONFIG_PATH` — путь к yaml-конфигу моделей (по умолчанию `llm_config.yaml`).  

## Запуск
1) Установите зависимости: `pip install -r requirements.txt`  
2) Скопируйте `.env.example` в `.env`, заполните ключи (`CLOUDRU_API_KEY` обязательно, при необходимости `GROQ_API_KEY`, `OPENROUTER_API_KEY`) и их `*_BASE_URL`, отредактируйте `llm_config.yaml`, если нужен другой набор моделей/параметров.  
3) Запустите: `python main.py`  

## Результаты тестов
В ходе ручных прогонов лучшей показала себя `ai-sage/GigaChat3-10B-A1.8B`: уверенно держит русский, даёт структурированный вывод и минимально шумные сниппеты. OpenRouter free-модели пробовали, но из-за rate-limit решили не держать их в дефолте; при наличии платного ключа их можно вернуть в `llm_config.yaml`.

Наблюдения по качеству моделей:
- `ai-sage/GigaChat3-10B-A1.8B`: лучшие ответы на русском, стабильный structured output/FC, меньше шумных или англоязычных вставок.
- `llama-3.1-8b-instant` (Groq): Чаще даёт неточные ответы и меньше фактических деталей.

Результаты тестов:

- `Найди последние новости о подкастах на русском и кратко перескажи`

Модель GigaChat3-10B-A1.8B:

Суммаризация:
1) Подкасты на сайте РИА Новости охватывают широкий спектр тем, включая историю русского флота, судостроение, полководцев и архитектурное наследие России.
2) Эксперты обсуждают развитие русского флота с древних времён до современных атомных ледоколов.
3) Проект «Обогнавшие время» стал призером премии «ШУМ» и посвящён архитектурному наследию России.
4) Подкасты доступны на различных платформах, включая Яндекс Музыка, Apple Podcasts и другие.

Модель llama-3.1-8b-instant:

1) В России аудитория подкастов увеличивается с каждым годом, и к 2024 году среднемесячная аудитория подкастов может достичь 27,9 млн слушателей.
2) Подкасты на любую тематику для взрослых и детей можно найти на почти всех крупных аудиоплощадках, включая ITunes, Spotify, «Яндекс.Музыку» и подкасты во «ВКонтакте».
3) Сегодня подкасты превратились в успешный бизнес, и оборот рекламы российского рынка подкастов может достичь 1,55 млрд рублей к 2024 году.
4) Подкасты могут быть не только развлекательным, но и образовательным форматом, и многие из них посвящены темам, связанным с ментальным здоровьем, бизнесом, digital-сферой, музыкой и генетикой.

- `Найди исследования про влияние кофеина на сон и определи тональность выводов`

Модель GigaChat3-10B-A1.8B:

1) Кофеин — самый распространённый психоактивный препарат в мире, который не регулируется как наркотик в большинстве стран. -> нейтрально: фактическая информация без явной оценки.  
2) Кофеин блокирует аденозиновые рецепторы, что способствует бодрости и улучшению когнитивных функций. -> позитив: подчёркивается положительное влияние кофеина на бодрость и когнитивные функции.
3) Кофеин может вызывать зависимость и симптомы отмены при резком прекращении употребления. -> негатив: акцентируется на негативном аспекте зависимости и отмены.
4) Кофеин содержится в большом количестве напитков, таких как кофе, чай и кола, и широко используется для повышения бодрости. -> нейтрально: информативное описание без явной оценки.

Модель llama-3.1-8b-instant:

Анализ тональности:
- "Ежедневное употребление 4 и более чашек кофе укорачивает ночной сон, но делает его заметно глубже": нейтрально (похвала визуалу компенсирована критикой управления).
- "Организм компенсирует недосып, делая глубокий сон более интенсивным, но пределы такой компенсации пока неизвестны": нейтрально (похвала визуалу компенсирована критикой управления).
- "Исследователи подчеркивают, что кофе не является полезным средством для сна, а мозг просто приспосабливается к постоянной стимуляции": негатив (жалоба на кофе).
- "Регулярное потребление кофеина может привести к сокращению продолжительности сна, но при этом оно может сделать его глубже": нейтрально (похвала визуалу компенсирована критикой управления).
- "Организм человека способен адаптироваться к регулярному поступлению кофеина, но адаптация не полная, что может привести к накоплению

- `Сравни тональность отзывов: "Сервис отличный" и "Поддержка не отвечает неделями"`

Модель GigaChat3-10B-A1.8B:

Анализ тональности:
- "Сервис отличный": позитив (прямая похвала сервиса)
- "Поддержка не отвечает неделями": негатив (жалоба на поддержку)

Модель llama-3.1-8b-instant:

Анализ тональности:
"Сервис отличный": позитив 
"Поддержка не отвечает неделями": негатив 

Сравнение тональности: негативная отзыв о поддержке преобладает над позитивной оценкой сервиса.

- `Что такое гребень Реджи?` (fallback для неочевидного запроса)

Модель GigaChat3-10B-A1.8B:

Гребень Реджи — это элемент одежды, представляющий собой гребень, который использовался в Италии в XVI веке для укладки и фиксации волос.

Модель llama-3.1-8b-instant:

Гребень Реджи - это морской гребень, находящийся в юго-западной части Тихого океана, в районе Фиджи. Он представляет собой подводный хребет, который образует часть островной цепи.
