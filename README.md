# AI агент на LangGraph

Агент на Python строит динамическую цепочку обработки пользовательского запроса: определяет интенты через LLM, собирает маршрут `search -> summarize -> sentiment` в нужном порядке либо уходит в `fallback`, обрабатывает шаги и возвращает финальный ответ. Поддержан быстрый и глубокий режим поиска.

## Архитектура
- Состояние (`agent/models.py`): `user_query`, `detected_intents`, `intermediate_result`, `final_answer`, `next_intent_index`, `search_mode`.
- Граф (`agent/graph.py`): узлы `intent_recognition -> router -> {search|summarize|sentiment|fallback} -> ... -> finalize`. Маршрутизация по списку интентов; по завершении - `finalize`.
- Ноды (`agent/handlers.py`):
  - `intent_recognition_node`: LLM + нормализация интентов, безопасный фолбэк в `["none"]` при ошибке.
  - `search_tool_handler`: DuckDuckGo, при неудаче - LLM-заглушка; deep-режим скачивает страницы и суммаризирует.
  - `summarize_handler`, `sentiment_handler`, `fallback_handler`: LLM-обработка с добавлением шага в общий ответ.
  - Все ноды обновляют общее состояние и сдвигают `next_intent_index`.
- Цепочки (`agent/chains.py`): промпты + LLM с structured output для интентов и поиска.
- CLI (`agent/cli.py`): цикл `input -> graph.invoke -> print`; для каждого запроса создаёт новое состояние с `search_mode="deep"`.
- Отказоустойчивость LLM: на каждую ноду задан приоритезированный список моделей; при ошибке текущей цепочка автоматически пробует следующую (`agent/config.py`, `iter_llms_for_node`).

## LLM и конфигурация
- Используется Groq (OpenAI-совместимый API): один API ключ, настраиваем приоритеты моделей по нодам графа.
- Конфигурация моделей и сэмплинга хранится в `llm_config.yaml`: список моделей с параметрами для каждой ноды (`intent`, `search`, `summarize`, `sentiment`, `fallback`); движок перебирает их по порядку до успешной.
- Параметры на модель: `temperature`, `top_p`, `max_tokens`; для интентов дефолт 0.0, для финального ответа можно выбрать более высокую температуру.
- Дефолтный набор: `llama-3.1-8b-instant`, `llama-3.3-70b-versatile`, `meta-llama/llama-4-scout-17b-16e-instruct`, `qwen/qwen3-32b`, `moonshotai/kimi-k2-instruct-0905` (см. `llm_config.yaml`).
- Путь к кастомному конфигу можно задать через `LLM_CONFIG_PATH`.

### Почему такие модели
- `llama-3.3-70b-versatile`: основной качественный вариант для интентов/поиска/суммаризации; хорошая точность рассуждений.
- `meta-llama/llama-4-scout-17b-16e-instruct`: усиливает поисковую генерацию и суммаризацию, балансирует между качеством и ценой.
- `llama-3.1-8b-instant`: быстрый и дешевый фолбэк для снижения латентности и стоимости.
- `qwen/qwen3-32b`: модель от другого вендора, повышает устойчивость при деградации линейки Llama и дает разнообразие данных.
- `moonshotai/kimi-k2-instruct-0905`: более креативный фолбэк для `fallback`-узла, если остальные недоступны.
- При недоступности/ошибке текущей модели система автоматически переключается на следующую в списке.

## Запуск
1) Установите зависимости: `pip install -r requirements.txt`  
2) Скопируйте `.env.example` в `.env`, укажите `GROQ_API_KEY` (и при необходимости `GROQ_BASE_URL`), отредактируйте `llm_config.yaml`, если нужен другой набор моделей/параметров.  
3) Запустите: `python main.py`  
4) Примеры ввода:  
   - `Найди последние новости о возобновляемой энергетике и кратко перескажи`  
   - `Найди статьи про Москвариум и оцени их тональность`  
   - `Перескажи текст: "В отчете говорится, что рынок вырос на 12% за квартал"`  
   - `Сравни тональность двух отзывов: "понравилось" и "ужасно"`  
   - `Что такое градиентный бустинг?` (уйдет в fallback)  
   - `Найди новости о ядерной энергетике, потом сделай краткий пересказ и оцени тональность`

## Соответствие ТЗ
- Интенты через LLM, поддержка множественных: `IntentPrediction` + нормализация в `intent_recognition_node`.
- Динамический граф LangGraph, порядок интентов учитывается; `search` перед `summarize`.
- Обработчики - отдельные ноды, обновляют общее состояние и итоговый ответ; `fallback` для `none`.
- Состояние на Pydantic с полями из ТЗ.
- Поток: `intent_recognition` -> динамические обработчики -> `finalize`.
- CLI-цикл, многократные запросы, состояние сбрасывается.
- Обработка ошибок: ленивый init LLM, фолбэки в поиске и интентах, логирование.

## Результаты тестов

- `Найди последние новости о подкастах на русском и кратко перескажи`

Из сниппетов можно сделать следующие выводы:

1. На русском языке существует множество подкастов на различные темы, включая музыку, книги, технологии, историю, культуру и многое другое.
2. Подкасты стали одним из самых популярных развлекательных и образовательных форматов, и их аудитория в России постоянно растет.
3. Существует множество подкастов, посвященных различным темам, таким как ментальное здоровье, бизнес, генетика, музыка и история, которые могут быть не только развлекательными, но и образовательными.
4. Некоторые подкасты стали очень популярными и вошли в топ подкастов с самой преданной аудиторией на различных платформах.
5. Рынок подкастов в России развивается быстро, и, по прогнозам, среднемесячная аудитория подкастов увеличится в ближайшие годы.

- `Найди исследования про влияние кофеина на сон и определи тональность выводов`

Тональность:
Тональность: Нейтрально

Обоснование:

Несмотря на то, что в сниппетах упоминаются как положительные, так и отрицательные эффекты кофеина, в целом информация представлена объективно и без эмоциональной нагрузки. В сниппетах не выражается явная позиция или мнение о кофеине, а скорее предоставляется факты и данные о его влиянии на организм человека.

Фактические тезисы:

1. Кофеин - это стимулятор центральной нервной системы, который широко потребляется по всему миру и может улучшать бдительность, когнитивные функции и физические способности.
2. Кофеин может иметь как положительные, так и отрицательные эффекты на здоровье, включая лечение и профилактику некоторых заболеваний, таких как синдром апноэ у недоношенных детей, но также может вызывать тревогу, бессонницу и зависимость.
3. Кофеин содержится в различных продуктах, включая кофе

- `Сравни тональность отзывов: "Сервис отличный" и "Поддержка не отвечает неделями"`

Тональность:
Тональность отзывов можно определить следующим образом:

- "Сервис отличный" - позитивная тональность. Это связано с тем, что в отзыве используется положительная оценка ("отличный"), которая выражает удовлетворенность и положительные эмоции.
- "Поддержка не отвечает неделями" - негативная тональность. В этом отзыве используется негативная оценка ("не отвечает"), которая выражает недовольство и отрицательные эмоции.

Сравнивая тональность этих двух отзывов, можно сказать, что первое отзыв имеет позитивную тональность, а второе - негативную. Это показывает, что первое отзыв выражает положительные эмоции и удовлетворенность, в то время как второе отзыв выражает отрицательные эмоции и недовольство.

- `Найди лучшие практики A/B-тестирования и перескажи в 3-4 тезисах`

Вот 3-5 фактических тезисов по содержанию сниппетов на русском языке:

1. A/B-тестирование является методом исследования, используемым для оценки эффективности различных вариантов страниц, элементов интерфейса или рекламных кампаний.
2. Основная цель A/B-тестирования - найти эффективную версию страницы, интерфейса или рекламного объявления, которая даст наибольшую конверсию или иные целевые показатели.
3. Для проведения A/B-тестирования необходимо определить цель, метрики и гипотезу, а также рассчитать объем выборки и длительность теста, чтобы обеспечить достоверность результатов.
4. Существуют различные сервисы и инструменты, которые можно использовать для проведения A/B-тестирования, включая встроенные сервисы и специальные сервисы, такие как Varioqub или Roistat.
5. Правильный выбор метрик и гипотезы имеет решающее значение для успеха A/B-тестирования, поскольку позволяет оценить эффективность изменений и принять обоснованное решение о дальнейших действиях.

- `Что такое гребень Реджи?` (fallback для неочевидного запроса)

Ответ:
Гребень Реджи - это характерная причёска, которую носил британский футболист Дэвид Реджис, также известный как Реджи, в 1970-х годах. Она характеризуется короткими волосами по бокам и назад, с более длинными волосами на верху головы, которые часто укладывались в характерный гребень. Причёска стала символом стиля и культуры 1970-х годов.

- `Найди свежие данные о ценах на литий и сделай короткий конспект`

Суммаризация:
Вот 3-5 фактических тезисов по содержанию сниппетов на русском языке:

1. Цена лития демонстрирует волатильность, с ростом на 0,64% по сравнению с предыдущим днем и увеличением на 16,48% за последний месяц.
2. Стоимость литий-ионных аккумуляторов значительно снизилась с 1991 по 2018 год, когда цена одного кВт·ч уменьшилась с $7500 до $181.
3. Литий является важным компонентом в производстве аккумуляторов для электромобилей, и его цена влияет на развитие рынка электротранспорта.
4. Отсутствие эталонной цены на литий создает неопределенность для промышленников и инвесторов, что может повлиять на развитие рынка лития.
5. Цена лития может колебаться в зависимости от различных факторов, включая объемы добычи, спрос и спекуляции.

- `Определи тональность обзора: "Игра выглядит красиво, но управление хромает"`

Тональность:
Тональность обзора: Негативная.

Обоснование: Хотя обзор начинается с положительной оценки игры ("Игра выглядит красиво"), негативная оценка управления ("но управление хромает") доминирует в обзоре. Это указывает на то, что автор обзора больше обеспокоен недостатками игры, чем ее преимуществами.