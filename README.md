
# AI Agent 

Реализация агента с динамической маршрутизацией на базе **LangGraph**.
Реализована **failover-логика**: на каждой ноде есть список приоритетных моделей. Если основная LLM отваливается или возвращает 5xx, агент прозрачно переключается на следующую в списке без падения пайплайна, что в целом повышает отказоустойчивость агента.

## Архитектура 

*   **State Management (`agent/models.py`)**:
    Основа графа. Состояние типизировано (`TypedDict`) и прокидывается через все ноды. В контексте держим: `user_query`, `detected_intents`, `intermediate_result`, `final_answer` и `search_mode`.
*   **Routing Logic (`agent/graph.py`)**:
    Здесь собран сам граф.
    `Intent Recognition` -> `Router` -> `Workers` -> `Finalizer`.
*   **Nodes & Handlers (`agent/handlers.py`)**:
    Воркеры для конкретных задач (поиск, суммаризация, сентимент)
*   **LLM Interaction (`agent/chains.py`)**:
    Слой взаимодействия с моделями. Везде, где возможно, используется **Structured Output** для получения валидного JSON, а не парсинг сырого текста.
*   **Resilience (`agent/config.py`)**:
    Итератор `iter_llms_for_node`. Для каждой задачи (например, `intent_recognition`) конфигурируется свой стек моделей. Ошибка одной модели триггерит следующую.

## LLM Strategy: Выбор моделей и провайдеров

Поддерживаются OpenAI-compatible API. Конфигурация вынесена в `llm_config.yaml`.
В текущем сетапе я отказался от бесплатных моделей с OpenRouter (слишком жесткие Rate Limits для продакшн-лайк тестов) в пользу более стабильных провайдеров.

**Текущий дефолтный стек:**
1.  **`ai-sage/GigaChat3-10B-A1.8B` (Cloud.ru)** — Primary.
    *   *Why:* Отличный контекст на русском, строго следует JSON-схеме (Function Calling), попадает в нужный баланс качества/скорости.
2.  **`llama-3.1-8b-instant` (Groq)** — Fallback.
    *   *Why:* Хороша для подстраховки, если GigaChat недоступен.

## Setup & Config

1.  **Environment**:
    ```bash
    pip install -r requirements.txt
    cp .env.example .env
    ```
    Заполните ключи: `CLOUDRU_API_KEY` (основной) и `GROQ_API_KEY` (резерв). Base URL уже прописаны.

2.  **LLM Configuration**:
    В `llm_config.yaml` можно тюнить параметры (`temperature`, `top_p`) пер-нода. Там же задается порядок перебора моделей.

3.  **Run**:
    ```bash
    python main.py
    ```
    CLI поддерживает команды: `models` (список) и `model=<name> query` (форсированный запуск конкретной модели).

---

## Результаты тестов

В ходе тестов сравнивались GigaChat и Llama-3.1-8b.
**Вывод:** `GigaChat3-10B` показывает себя лучше в RAG-сценариях на русском языке — меньше галлюцинаций в фактах и чище структура ответа. Llama на Groq быстрее, но склонна к "шуму" и потере контекста.

Ниже приведены сырые результаты прогонов без редактирования текста.

### Case 1: Поиск и суммаризация
**Query:** `Найди последние новости о подкастах на русском и кратко перескажи`

| Модель | Результат (raw text) |
| :--- | :--- |
| **GigaChat3-10B-A1.8B** | 1) Подкасты на сайте РИА Новости охватывают широкий спектр тем, включая историю русского флота, судостроение, полководцев и архитектурное наследие России.<br>2) Эксперты обсуждают развитие русского флота с древних времён до современных атомных ледоколов.<br>3) Проект «Обогнавшие время» стал призером премии «ШУМ» и посвящён архитектурному наследию России.<br>4) Подкасты доступны на различных платформах, включая Яндекс Музыка, Apple Podcasts и другие. |
| **llama-3.1-8b-instant** | 1) В России аудитория подкастов увеличивается с каждым годом, и к 2024 году среднемесячная аудитория подкастов может достичь 27,9 млн слушателей.<br>2) Подкасты на любую тематику для взрослых и детей можно найти на почти всех крупных аудиоплощадках, включая ITunes, Spotify, «Яндекс.Музыку» и подкасты во «ВКонтакте».<br>3) Сегодня подкасты превратились в успешный бизнес, и оборот рекламы российского рынка подкастов может достичь 1,55 млрд рублей к 2024 году.<br>4) Подкасты могут быть не только развлекательным, но и образовательным форматом, и многие из них посвящены темам, связанным с ментальным здоровьем, бизнесом, digital-сферой, музыкой и генетикой. |

### Case 2: Поиск и сантимент
**Query:** `Найди исследования про влияние кофеина на сон и определи тональность выводов`

| Модель | Результат (raw text) |
| :--- | :--- |
| **GigaChat3-10B-A1.8B** | 1) Кофеин — самый распространённый психоактивный препарат в мире, который не регулируется как наркотик в большинстве стран. -> нейтрально: фактическая информация без явной оценки.<br>2) Кофеин блокирует аденозиновые рецепторы, что способствует бодрости и улучшению когнитивных функций. -> позитив: подчёркивается положительное влияние кофеина на бодрость и когнитивные функции.<br>3) Кофеин может вызывать зависимость и симптомы отмены при резком прекращении употребления. -> негатив: акцентируется на негативном аспекте зависимости и отмены.<br>4) Кофеин содержится в большом количестве напитков, таких как кофе, чай и кола, и широко используется для повышения бодрости. -> нейтрально: информативное описание без явной оценки. |
| **llama-3.1-8b-instant** | **Анализ тональности:**<br>- "Ежедневное употребление 4 и более чашек кофе укорачивает ночной сон, но делает его заметно глубже": нейтрально (похвала визуалу компенсирована критикой управления).<br>- "Организм компенсирует недосып, делая глубокий сон более интенсивным, но пределы такой компенсации пока неизвестны": нейтрально (похвала визуалу компенсирована критикой управления).<br>- "Исследователи подчеркивают, что кофе не является полезным средством для сна, а мозг просто приспосабливается к постоянной стимуляции": негатив (жалоба на кофе).<br>- "Регулярное потребление кофеина может привести к сокращению продолжительности сна, но при этом оно может сделать его глубже": нейтрально (похвала визуалу компенсирована критикой управления).<br>- "Организм человека способен адаптироваться к регулярному поступлению кофеина, но адаптация не полная, что может привести к накоплению |

### Case 3: Сантимент
**Query:** `Сравни тональность отзывов: "Сервис отличный" и "Поддержка не отвечает неделями"`

| Модель | Анализ |
| :--- | :--- |
| **GigaChat3-10B-A1.8B** | **Анализ тональности:**<br>- "Сервис отличный": позитив (прямая похвала сервиса)<br>- "Поддержка не отвечает неделями": негатив (жалоба на поддержку) |
| **llama-3.1-8b-instant** | **Анализ тональности:**<br>"Сервис отличный": позитив<br>"Поддержка не отвечает неделями": негатив<br><br>**Сравнение тональности:** негативная отзыв о поддержке преобладает над позитивной оценкой сервиса. |

### Case 4: Вопрос без интента
**Query:** `Что такое гребень Реджи?` (Неочевидный запрос)

| Модель | Ответ |
| :--- | :--- |
| **GigaChat3-10B-A1.8B** | Гребень Реджи — это элемент одежды, представляющий собой гребень, который использовался в Италии в XVI веке для укладки и фиксации волос. |
| **llama-3.1-8b-instant** | Гребень Реджи - это морской гребень, находящийся в юго-западной части Тихого океана, в районе Фиджи. Он представляет собой подводный хребет, который образует часть островной цепи. |
